<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SpineåŠ¨ç”»åºåˆ—å¸§å¯¼å‡ºå·¥å…·</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js"></script>
        <script src="https://unpkg.com/@esotericsoftware/spine-pixi-v7@4.2.*/dist/iife/spine-pixi-v7.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
        <style>
            :root {
                --primary-color: #4a6fc7;
                --secondary-color: #34495e;
                --accent-color: #1abc9c;
                --light-color: #ecf0f1;
                --dark-color: #2c3e50;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                background: linear-gradient(
                    135deg,
                    var(--secondary-color),
                    var(--dark-color)
                );
                color: var(--light-color);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            header {
                text-align: center;
                padding: 20px 0;
                margin-bottom: 30px;
            }

            h1 {
                font-size: 2.8rem;
                margin-bottom: 10px;
                background: linear-gradient(
                    to right,
                    var(--primary-color),
                    var(--accent-color)
                );
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
                text-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }

            .subtitle {
                font-size: 1.1rem;
                color: #bdc3c7;
                max-width: 600px;
                margin: 0 auto;
                line-height: 1.6;
            }

            .main-content {
                display: grid;
                grid-template-columns: 1fr 350px;
                gap: 25px;
            }

            .animation-section {
                background: rgba(30, 40, 52, 0.7);
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                position: relative;
                height: 75vh;
            }

            #rendererContainer {
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 8px;
                overflow: hidden;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .control-section {
                background: rgba(30, 40, 52, 0.7);
                border-radius: 12px;
                padding: 25px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                height: 75vh;
                overflow-y: auto;
            }

            .section-title {
                font-size: 1.4rem;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid var(--accent-color);
                color: var(--accent-color);
            }

            .control-group {
                margin-bottom: 25px;
            }

            label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                color: #bdc3c7;
            }

            input,
            select {
                width: 100%;
                padding: 12px;
                background: rgba(15, 22, 33, 0.8);
                border: 1px solid #445;
                border-radius: 6px;
                color: var(--light-color);
                font-size: 1rem;
                margin-bottom: 5px;
            }

            input:focus,
            select:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 2px rgba(74, 111, 199, 0.3);
            }

            .file-upload-box {
                border: 2px dashed #556;
                border-radius: 8px;
                padding: 20px;
                text-align: center;
                margin-bottom: 15px;
                background: rgba(15, 22, 33, 0.4);
                cursor: pointer;
                transition: all 0.3s;
            }

            .file-upload-box:hover {
                border-color: var(--accent-color);
                background: rgba(15, 22, 33, 0.6);
            }

            .file-upload-box p {
                margin: 10px 0;
            }

            .button-group {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 15px;
            }

            .btn {
                padding: 12px 18px;
                background: var(--primary-color);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                flex: 1;
                min-width: 120px;
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                background: #3e5fbc;
            }

            .btn.secondary {
                background: var(--secondary-color);
            }

            .btn.secondary:hover {
                background: #2c3e50;
            }

            .btn.accent {
                background: var(--accent-color);
            }

            .btn.accent:hover {
                background: #16a085;
            }

            .file-list {
                background: rgba(15, 22, 33, 0.5);
                border-radius: 6px;
                padding: 10px;
                margin-top: 15px;
                max-height: 150px;
                overflow-y: auto;
            }

            .file-item {
                padding: 8px;
                margin-bottom: 5px;
                background: rgba(30, 40, 52, 0.5);
                border-radius: 4px;
                display: flex;
                align-items: center;
            }

            .file-icon {
                margin-right: 10px;
                font-size: 1.2rem;
                width: 24px;
                text-align: center;
            }

            .frame-preview {
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .frames-list {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                max-height: 200px;
                overflow-y: auto;
                padding: 5px;
                background: rgba(15, 22, 33, 0.3);
                border-radius: 6px;
                margin-top: 10px;
            }

            .frame-item {
                width: 80px;
                height: 80px;
                background-color: #000;
                border-radius: 4px;
                overflow: hidden;
                cursor: pointer;
                opacity: 0.7;
                transition: all 0.2s;
            }

            .frame-item:hover {
                opacity: 1;
                transform: scale(1.05);
            }

            .frame-item img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            .progress-container {
                background: rgba(0, 0, 0, 0.3);
                height: 10px;
                border-radius: 5px;
                margin: 15px 0;
                overflow: hidden;
                display: none;
            }

            .progress-bar {
                height: 100%;
                background: var(--accent-color);
                border-radius: 5px;
                width: 0%;
                transition: width 0.3s;
            }

            .instructions {
                background: rgba(15, 22, 33, 0.7);
                padding: 15px;
                border-radius: 8px;
                margin-top: 20px;
                font-size: 0.9rem;
            }

            .instructions h3 {
                color: var(--accent-color);
                margin-bottom: 10px;
            }

            .instructions ol {
                padding-left: 20px;
            }

            .instructions li {
                margin-bottom: 8px;
            }

            footer {
                text-align: center;
                padding: 25px 0;
                margin-top: 30px;
                color: #95a5a6;
                font-size: 0.9rem;
            }

            @media (max-width: 900px) {
                .main-content {
                    grid-template-columns: 1fr;
                }

                .animation-section,
                .control-section {
                    height: auto;
                    min-height: 500px;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>SpineåŠ¨ç”»åºåˆ—å¸§å¯¼å‡ºå·¥å…·</h1>
                <p class="subtitle">
                    ä¸Šä¼ æ‚¨çš„SpineåŠ¨ç”»æ–‡ä»¶ï¼ˆJSONã€Atlasã€PNGï¼‰ï¼Œå¯¼å‡ºä¸ºåºåˆ—å¸§å›¾ç‰‡æˆ–GIFåŠ¨ç”»
                </p>
            </header>

            <div class="main-content">
                <div class="animation-section">
                    <h2 class="section-title">åŠ¨ç”»é¢„è§ˆåŒº</h2>
                    <div id="rendererContainer">
                        <p id="loadingText">è¯·ä¸Šä¼ Spineæ–‡ä»¶å¼€å§‹é¢„è§ˆ...</p>
                    </div>
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>

                <div class="control-section">
                    <h2 class="section-title">æ§åˆ¶é¢æ¿</h2>

                    <div class="control-group">
                        <label for="spineFiles">Spineèµ„æºæ–‡ä»¶</label>
                        <div class="file-upload-box" id="fileUploadBox">
                            <p>å°†æ–‡ä»¶æ‹–æ”¾åˆ°æ­¤å¤„ æˆ–</p>
                            <input
                                type="file"
                                id="fileInput"
                                multiple
                                style="display: none"
                            />
                            <button class="btn secondary" id="selectFilesBtn">
                                é€‰æ‹©Spineæ–‡ä»¶
                            </button>
                        </div>

                        <div class="file-list" id="fileList">
                            <div id="jsonStatus" class="file-item">
                                <div class="file-icon">ğŸ“</div>
                                JSONæ–‡ä»¶ï¼šæœªé€‰æ‹©
                            </div>
                            <div id="atlasStatus" class="file-item">
                                <div class="file-icon">ğŸ“</div>
                                Atlasæ–‡ä»¶ï¼šæœªé€‰æ‹©
                            </div>
                            <div id="imageStatus" class="file-item">
                                <div class="file-icon">ğŸ–¼ï¸</div>
                                PNGçº¹ç†ï¼šæœªé€‰æ‹©
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="btn" id="playButton" disabled>
                                æ’­æ”¾åŠ¨ç”»
                            </button>
                            <button
                                class="btn secondary"
                                id="pauseButton"
                                disabled
                            >
                                æš‚åœ
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="fps">å¸§ç‡ (FPS)</label>
                        <input
                            type="number"
                            id="fps"
                            value="24"
                            min="1"
                            max="60"
                        />

                        <label for="resolution">åˆ†è¾¨ç‡ç¼©æ”¾ (%)</label>
                        <input
                            type="number"
                            id="resolution"
                            value="100"
                            min="10"
                            max="200"
                        />

                        <label for="animationName">åŠ¨ç”»åç§°</label>
                        <select id="animationSelect" disabled>
                            <option value="">è¯·å…ˆåŠ è½½æ–‡ä»¶</option>
                        </select>

                        <div class="button-group">
                            <button class="btn" id="captureButton" disabled>
                                æ•è·åºåˆ—å¸§
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="button-group">
                            <button class="btn" id="exportPng" disabled>
                                å¯¼å‡ºPNGåºåˆ—
                            </button>
                            <button class="btn" id="exportZip" disabled>
                                å¯¼å‡ºZIPå‹ç¼©åŒ…
                            </button>
                            <button class="btn accent" id="exportGif" disabled>
                                å¯¼å‡ºGIFåŠ¨ç”»
                            </button>
                        </div>
                    </div>

                    <div class="frame-preview">
                        <h3 class="section-title">æ•è·å¸§é¢„è§ˆ</h3>
                        <p id="frameCount">å·²æ•è·: 0 å¸§</p>
                        <div class="frames-list" id="framesList">
                            <!-- åŠ¨æ€æ·»åŠ å¸§é¢„è§ˆ -->
                        </div>
                    </div>

                    <div class="instructions">
                        <h3>ä½¿ç”¨è¯´æ˜:</h3>
                        <ol>
                            <li>ä¸Šä¼ Spineçš„JSONã€Atlaså’ŒPNGæ–‡ä»¶</li>
                            <li>é€‰æ‹©è¦å¯¼å‡ºçš„åŠ¨ç”»åç§°</li>
                            <li>è®¾ç½®å¸§ç‡å’Œåˆ†è¾¨ç‡</li>
                            <li>ç‚¹å‡»"æ•è·åºåˆ—å¸§"å¼€å§‹æ•è·</li>
                            <li>å¯¼å‡ºä¸ºPNGåºåˆ—ã€ZIPæˆ–GIFæ ¼å¼</li>
                        </ol>
                        <p><i>æ³¨æ„: è¿‡é•¿çš„åŠ¨ç”»å¯èƒ½ä¼šå½±å“æµè§ˆå™¨æ€§èƒ½</i></p>
                    </div>
                </div>
            </div>

            <footer>
                <p>Â© 2023 SpineåŠ¨ç”»åºåˆ—å¸§å¯¼å‡ºå·¥å…· | åŸºäºPixiJSå’ŒSpineè¿è¡Œæ—¶</p>
            </footer>
        </div>

        <script>
            // å…¨å±€å˜é‡
            let app, spineAnim
            let capturedFrames = []
            let captureInterval
            let isCapturing = false
            let currentFrame = 0
            let totalFrames = 0
            let spineAssets = {
                json: null,
                atlas: null,
                image: null,
            }
            if (!PIXI.spine) {
                PIXI.spine = spine
            }

            // åˆå§‹åŒ–Pixiåº”ç”¨
            function initRenderer() {
                const container = document.getElementById('rendererContainer')
                app = new PIXI.Application({
                    backgroundAlpha: 0,
                    width: container.clientWidth,
                    height: container.clientHeight,
                })

                // æ·»åŠ å¹³æ»‘çš„æŠ—é”¯é½¿
                app.renderer.antialias = true

                container.appendChild(app.view)

                // æ·»åŠ å¸®åŠ©æ–‡æœ¬
                const helpText = new PIXI.Text('è¯·åŠ è½½SpineåŠ¨ç”»æ–‡ä»¶', {
                    fontFamily: 'Arial',
                    fontSize: 20,
                    fill: 0xaaaaaa,
                })
                helpText.anchor.set(0.5)
                helpText.position.set(
                    app.screen.width / 2,
                    app.screen.height / 2
                )
                app.stage.addChild(helpText)
            }

            // æ›´æ–°æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
            function updateFileStatus(type, fileName) {
                const statusElement = document.getElementById(`${type}Status`)
                if (fileName) {
                    const ext = fileName.split('.').pop().toUpperCase()
                    statusElement.innerHTML = `
                    <div class="file-icon">${
                        type === 'image' ? 'ğŸ–¼ï¸' : 'ğŸ“'
                    }</div>
                    <span>${type.toUpperCase()}æ–‡ä»¶ï¼š${fileName}</span>
                    <span style="margin-left: auto; color: var(--accent-color)">âœ“</span>
                `
                    // spineAssets[type] = fileName;
                } else {
                    statusElement.innerHTML = `
                    <div class="file-icon">${
                        type === 'image' ? 'ğŸ–¼ï¸' : 'ğŸ“'
                    }</div>
                    ${
                        type === 'image'
                            ? 'PNGçº¹ç†'
                            : type.toUpperCase() + 'æ–‡ä»¶'
                    }: æœªé€‰æ‹©
                `
                    // spineAssets[type] = null;
                }
            }

            // åŠ è½½SpineåŠ¨ç”»
            async function loadSpineAnimation() {
                const jsonFile = spineAssets.json
                const atlasFile = spineAssets.atlas
                const imageFile = spineAssets.image

                if (!jsonFile || !atlasFile || !imageFile) {
                    alert('è¯·ä¸Šä¼ æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶ï¼šJSONã€Atlaså’ŒPNG')
                    return
                }

                try {
                    // æ˜¾ç¤ºåŠ è½½æ–‡æœ¬
                    const helpText = app.stage.children[0]
                    helpText.text = 'æ­£åœ¨åŠ è½½SpineåŠ¨ç”»...'
                    helpText.style.fill = 0x1abc9c

                    // åˆ›å»ºå›¾åƒçº¹ç†
                    const texture = PIXI.Texture.from(imageFile)
                    const res = await new Promise((resolve, reject) =>
                        texture.on('update', resolve)
                    )

                    // åˆ›å»ºSpineå¯¹è±¡
                    const atlasLoader = {
                        load: function (atlasContent, onLoad) {
                            // åˆ›å»ºä¸€ä¸ªè™šå‡çš„AtlasLoader
                            const atlas = new PIXI.spine.core.TextureAtlas()
                            const page = new PIXI.spine.core.TextureAtlasPage()
                            page.name = 'texturePage'
                            page.texture = texture
                            page.width = texture.width
                            page.height = texture.height
                            atlas.pages.push(page)

                            // è§£æatlaså†…å®¹
                            const lines = atlasContent.split('\n')
                            for (let i = 0; i < lines.length; i++) {
                                const line = lines[i].trim()
                                if (!line) continue

                                // è§£æåŒºåŸŸ
                                if (
                                    line.endsWith('.png') ||
                                    line.endsWith('.jpg')
                                ) {
                                    // è·³è¿‡é¡µé¢è¡Œ
                                    continue
                                }

                                const region =
                                    new PIXI.spine.core.TextureAtlasRegion()
                                region.name = line
                                region.page = page

                                // ä¸‹ä¸€ä¸ªè¡Œæ˜¯xyä½ç½®
                                i++
                                const [x, y, width, height] = lines[i]
                                    .split(':')[1]
                                    .trim()
                                    .split(',')
                                    .map(Number)
                                region.x = x
                                region.y = y
                                region.width = width
                                region.height = height

                                // è§£æåç§»å’ŒåŸå§‹å°ºå¯¸
                                i++
                                const [offsetX, offsetY] = lines[i]
                                    .split(':')[1]
                                    .trim()
                                    .split(',')
                                    .map(Number)
                                i++
                                const [origWidth, origHeight] = lines[i]
                                    .split(':')[1]
                                    .trim()
                                    .split(',')
                                    .map(Number)

                                region.originalWidth = origWidth
                                region.originalHeight = origHeight
                                region.offsetX = offsetX
                                region.offsetY = offsetY

                                // è®¡ç®—UV
                                region.u = x / texture.width
                                region.v = y / texture.height
                                region.u2 = (x + width) / texture.width
                                region.v2 = (y + height) / texture.height

                                // æ—‹è½¬å¤„ç†ï¼ˆå‡è®¾å¤‡æ³¨ï¼‰
                                region.rotate = false

                                atlas.regions.push(region)
                            }

                            onLoad(atlas)
                        },
                    }

                    // åŠ è½½JSONéª¨æ¶æ•°æ®
                    // const loadedResources = await PIXI.loadJson.load(jsonFile)
                    
                    const jsonData =
                        jsonFile[Object.keys(jsonFile)[0]].data
                    // åˆ›å»ºéª¨æ¶è§£æå™¨
                    const skeletonJson = new PIXI.spine.SkeletonJson(
                        atlasLoader
                    )
                   const spineData = skeletonJson.readSkeletonData(jsonData)
      

                    // åˆ›å»ºSpineåŠ¨ç”»å®ä¾‹
                    spineAnim = new PIXI.spine.Spine(spineData)

                    // è®¾ç½®ä½ç½®å’Œç¼©æ”¾
                    spineAnim.position.set(
                        app.screen.width / 2,
                        app.screen.height * 0.8
                    )
                    spineAnim.scale.set(0.5)

                    // æ·»åŠ åˆ°èˆå°
                    app.stage.addChild(spineAnim)

                    // æ›´æ–°åŠ¨ç”»é€‰æ‹©å™¨
                    updateAnimationSelector(
                        spineData.animations.map((a) => a.name)
                    )

                    // ç§»é™¤å¸®åŠ©æ–‡æœ¬
                    app.stage.removeChild(helpText)

                    // å¯ç”¨æ§åˆ¶æŒ‰é’®
                    document.getElementById('playButton').disabled = false
                    document.getElementById('pauseButton').disabled = false
                    document.getElementById('captureButton').disabled = false

                    console.log('SpineåŠ¨ç”»åŠ è½½å®Œæˆ')
                } catch (error) {
                    console.error('åŠ è½½SpineåŠ¨ç”»å¤±è´¥:', error)
                    alert('åŠ è½½SpineåŠ¨ç”»å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®')
                }
            }

            // æ›´æ–°åŠ¨ç”»é€‰æ‹©å™¨
            function updateAnimationSelector(animations) {
                const select = document.getElementById('animationSelect')
                select.innerHTML = ''
                animations.forEach((anim) => {
                    const option = document.createElement('option')
                    option.value = anim
                    option.textContent = anim
                    select.appendChild(option)
                })
                select.disabled = false
                document.getElementById('exportPng').disabled = false
                document.getElementById('exportZip').disabled = false
                document.getElementById('exportGif').disabled = false
            }

            // æ’­æ”¾åŠ¨ç”»
            function playAnimation() {
                const animName =
                    document.getElementById('animationSelect').value
                if (!spineAnim || !animName) return

                try {
                    spineAnim.state.setAnimation(0, animName, true)
                    spineAnim.state.timeScale = 1.0
                } catch (e) {
                    alert(`æ— æ³•æ’­æ”¾åŠ¨ç”» '${animName}'`)
                }
            }

            // æš‚åœåŠ¨ç”»
            function pauseAnimation() {
                if (spineAnim) {
                    spineAnim.state.timeScale = 0
                }
            }

            // å¼€å§‹æ•è·å¸§
            function startCapture() {
                if (!spineAnim) {
                    alert('è¯·å…ˆåŠ è½½SpineåŠ¨ç”»')
                    return
                }

                const animName =
                    document.getElementById('animationSelect').value
                if (!animName) {
                    alert('è¯·é€‰æ‹©åŠ¨ç”»åç§°')
                    return
                }

                // é‡ç½®æ•è·çŠ¶æ€
                capturedFrames = []
                document.getElementById('frameCount').textContent =
                    'å·²æ•è·: 0 å¸§'
                document.getElementById('framesList').innerHTML = ''

                // è·å–ç”¨æˆ·è®¾ç½®
                const fps = parseInt(document.getElementById('fps').value) || 24
                const scale =
                    parseInt(document.getElementById('resolution').value) /
                        100 || 1

                // æ’­æ”¾æŒ‡å®šåŠ¨ç”»
                spineAnim.state.setAnimation(0, animName, false)
                spineAnim.state.timeScale = 1.0
                spineAnim.state.tracks[0].animationStart = 0

                // è®¡ç®—æ€»å¸§æ•°
                const duration = spineAnim.state.tracks[0].animationEnd
                totalFrames = Math.ceil(duration * fps)

                // æ˜¾ç¤ºè¿›åº¦æ¡
                const progressContainer =
                    document.getElementById('progressContainer')
                const progressBar = document.getElementById('progressBar')
                progressContainer.style.display = 'block'
                progressBar.style.width = '0%'

                // è®¾ç½®æ•è·çŠ¶æ€
                currentFrame = 0
                isCapturing = true

                // é€å¸§æ•è·
                captureInterval = setInterval(() => {
                    if (!spineAnim || !isCapturing) return

                    // æ¸²æŸ“å½“å‰å¸§
                    app.render()

                    // æ•è·å¸§
                    captureFrame(scale)

                    // æ‰‹åŠ¨æ›´æ–°åŠ¨ç”»
                    const timeDelta = 1 / fps
                    spineAnim.state.update(timeDelta)
                    spineAnim.state.apply(spineAnim.skeleton)
                    spineAnim.update(timeDelta)

                    // æ›´æ–°è¿›åº¦
                    currentFrame++
                    progressBar.style.width = `${
                        (currentFrame / totalFrames) * 100
                    }%`

                    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                    if (
                        currentFrame >= totalFrames ||
                        spineAnim.state.tracks[0].trackTime >= duration
                    ) {
                        stopCapture()

                        // è‡ªåŠ¨æç¤º
                        setTimeout(() => {
                            alert(
                                `å·²æˆåŠŸæ•è· ${totalFrames} å¸§ï¼Œç°åœ¨å¯ä»¥å¯¼å‡ºåŠ¨ç”»åºåˆ—äº†`
                            )
                        }, 500)
                    }
                }, 1000 / fps)
            }

            // æ•è·å¸§
            function captureFrame(scale) {
                const canvas = app.renderer.view
                const tempCanvas = document.createElement('canvas')
                const tempCtx = tempCanvas.getContext('2d')

                // è®¾ç½®ç¼©æ”¾
                tempCanvas.width = canvas.width * scale
                tempCanvas.height = canvas.height * scale

                // ç»˜åˆ¶ç¼©æ”¾åçš„å›¾åƒ
                tempCtx.drawImage(
                    canvas,
                    0,
                    0,
                    canvas.width,
                    canvas.height,
                    0,
                    0,
                    tempCanvas.width,
                    tempCanvas.height
                )

                // è·å–æ•°æ®URL
                const dataURL = tempCanvas.toDataURL('image/png')
                capturedFrames.push(dataURL)

                // æ›´æ–°å¸§é¢„è§ˆ
                updateFramePreview(dataURL)
            }

            // æ›´æ–°å¸§é¢„è§ˆ
            function updateFramePreview(frameUrl) {
                const frameCount = capturedFrames.length
                document.getElementById(
                    'frameCount'
                ).textContent = `å·²æ•è·: ${frameCount} å¸§`

                // ä»…åœ¨ä½äº20å¸§æ—¶æ·»åŠ é¢„è§ˆä»¥æé«˜æ€§èƒ½
                if (frameCount < 20) {
                    const list = document.getElementById('framesList')
                    const frameItem = document.createElement('div')
                    frameItem.className = 'frame-item'

                    const img = document.createElement('img')
                    img.src = frameUrl
                    frameItem.appendChild(img)

                    list.appendChild(frameItem)
                }
            }

            // åœæ­¢æ•è·
            function stopCapture() {
                clearInterval(captureInterval)
                isCapturing = false

                // æ¢å¤åŸå§‹åŠ¨ç”»çŠ¶æ€
                if (spineAnim) {
                    const animName =
                        document.getElementById('animationSelect').value
                    spineAnim.state.setAnimation(0, animName, false)
                }
            }

            // å¯¼å‡ºPNGåºåˆ—
            async function exportPngSequence() {
                if (capturedFrames.length === 0) {
                    alert('è¯·å…ˆæ•è·åŠ¨ç”»åºåˆ—')
                    return
                }

                try {
                    // åˆ›å»ºZIPæ–‡ä»¶
                    const zip = new JSZip()
                    const animName =
                        document.getElementById('animationSelect').value
                    const cleanName = animName.replace(/[^a-z0-9]/gi, '_')

                    // æ·»åŠ æ¯å¸§å›¾åƒåˆ°ZIP
                    for (let i = 0; i < capturedFrames.length; i++) {
                        // ä»Data URLä¸­æå–Base64æ•°æ®
                        const base64Data = capturedFrames[i].split(',')[1]

                        // æ·»åŠ åˆ°ZIPæ–‡ä»¶
                        zip.file(
                            `${cleanName}_frame_${String(i).padStart(
                                4,
                                '0'
                            )}.png`,
                            base64Data,
                            { base64: true }
                        )
                    }

                    // ç”ŸæˆZIP
                    const zipBlob = await zip.generateAsync({ type: 'blob' })

                    // ä¿å­˜æ–‡ä»¶
                    saveAs(zipBlob, `${cleanName}_frames.zip`)
                } catch (error) {
                    console.error('å¯¼å‡ºPNGåºåˆ—å¤±è´¥:', error)
                    alert('å¯¼å‡ºPNGåºåˆ—æ—¶å‡ºé”™')
                }
            }

            // å¯¼å‡ºå•ä¸ªGIF
            function exportSingleGif() {
                if (capturedFrames.length === 0) {
                    alert('è¯·å…ˆæ•è·åŠ¨ç”»åºåˆ—')
                    return
                }

                try {
                    // åˆ›å»ºä¸´æ—¶Canvas
                    const tempCanvas = document.createElement('canvas')
                    const tempCtx = tempCanvas.getContext('2d')

                    // è®¾ç½®Canvaså°ºå¯¸ï¼ˆä½¿ç”¨ç¬¬ä¸€å¸§çš„å°ºå¯¸ï¼‰
                    const firstFrame = capturedFrames[0]
                    const img = new Image()
                    img.src = firstFrame

                    img.onload = () => {
                        tempCanvas.width = img.width
                        tempCanvas.height = img.height

                        // åˆ›å»ºGIFç¼–ç å™¨
                        const fps =
                            parseInt(document.getElementById('fps').value) || 24
                        const delay = 1000 / fps

                        const gif = new GIF({
                            workers: 2,
                            quality: 10,
                            width: tempCanvas.width,
                            height: tempCanvas.height,
                        })

                        // é€å¸§æ·»åŠ 
                        capturedFrames.forEach((dataUrl) => {
                            const img = new Image()
                            img.src = dataUrl

                            // ç­‰å¾…å›¾åƒåŠ è½½
                            img.onload = () => {
                                // ç»˜åˆ¶åˆ°Canvas
                                tempCtx.clearRect(
                                    0,
                                    0,
                                    tempCanvas.width,
                                    tempCanvas.height
                                )
                                tempCtx.drawImage(img, 0, 0)

                                // æ·»åŠ å¸§åˆ°GIF
                                gif.addFrame(tempCtx, {
                                    copy: true,
                                    delay: delay,
                                })
                            }
                        })

                        // ç”ŸæˆGIF
                        gif.on('finished', function (blob) {
                            const animName =
                                document.getElementById('animationSelect').value
                            const cleanName = animName.replace(
                                /[^a-z0-9]/gi,
                                '_'
                            )
                            saveAs(blob, `${cleanName}.gif`)
                        })

                        gif.render()
                    }
                } catch (error) {
                    console.error('å¯¼å‡ºGIFå¤±è´¥:', error)
                    alert('å¯¼å‡ºGIFæ—¶å‡ºé”™')
                }
            }

            // åˆå§‹åŒ–é¡µé¢
            document.addEventListener('DOMContentLoaded', () => {
                // åˆå§‹åŒ–æ¸²æŸ“å™¨
                initRenderer()

                // è®¾ç½®æ‹–æ”¾æ–‡ä»¶ä¸Šä¼ 
                const fileUploadBox = document.getElementById('fileUploadBox')
                const fileInput = document.getElementById('fileInput')
                const selectFilesBtn = document.getElementById('selectFilesBtn')

                // ç‚¹å‡»æŒ‰é’®æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
                selectFilesBtn.addEventListener('click', () => {
                    fileInput.click()
                })

                // å¤„ç†æ–‡ä»¶é€‰æ‹©
                fileInput.addEventListener('change', (e) => {
                    handleFileSelect(e.target.files)
                })

                // è®¾ç½®æ‹–æ”¾äº‹ä»¶
                fileUploadBox.addEventListener('dragover', (e) => {
                    e.preventDefault()
                    // fileUploadBox.style.borderColor = var('--accent-color');
                })

                fileUploadBox.addEventListener('dragleave', () => {
                    fileUploadBox.style.borderColor = '#556'
                })

                fileUploadBox.addEventListener('drop', (e) => {
                    e.preventDefault()
                    handleFileSelect(e.dataTransfer.files)
                    fileUploadBox.style.borderColor = '#556'
                })

                // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬
                document
                    .getElementById('playButton')
                    .addEventListener('click', playAnimation)
                document
                    .getElementById('pauseButton')
                    .addEventListener('click', pauseAnimation)
                document
                    .getElementById('captureButton')
                    .addEventListener('click', startCapture)
                document
                    .getElementById('exportPng')
                    .addEventListener('click', exportPngSequence)
                document
                    .getElementById('exportZip')
                    .addEventListener('click', exportPngSequence)
                document
                    .getElementById('exportGif')
                    .addEventListener('click', exportSingleGif)

                // æ·»åŠ å“åº”å¼è°ƒæ•´
                window.addEventListener('resize', () => {
                    if (app) {
                        const container =
                            document.getElementById('rendererContainer')
                        app.renderer.resize(
                            container.clientWidth,
                            container.clientHeight
                        )

                        if (spineAnim) {
                            spineAnim.position.set(
                                container.clientWidth / 2,
                                container.clientHeight * 0.7
                            )
                        } else {
                            const helpText = app.stage.children[0]
                            if (helpText) {
                                helpText.position.set(
                                    app.screen.width / 2,
                                    app.screen.height / 2
                                )
                            }
                        }
                    }
                })
            })

            // å¤„ç†æ–‡ä»¶é€‰æ‹©
            function handleFileSelect(files) {
                if (!files || files.length === 0) return

                Array.from(files).forEach((file) => {
                    const ext = file.name.split('.').pop().toLowerCase()

                    // æ£€æµ‹æ–‡ä»¶ç±»å‹
                    if (ext === 'json') {
                        const reader = new FileReader()
                        reader.onload = (e) => {
                            spineAssets.json = JSON.parse(e.target.result)
                            updateFileStatus('json', file.name)
                            tryLoadAnimation()
                        }
                        reader.readAsText(file)
                    } else if (ext === 'atlas') {
                        const reader = new FileReader()
                        reader.onload = (e) => {
                            spineAssets.atlas = e.target.result
                            updateFileStatus('atlas', file.name)
                            tryLoadAnimation()
                        }
                        reader.readAsText(file)
                    } else if (['png', 'jpg', 'jpeg'].includes(ext)) {
                        const url = URL.createObjectURL(file)
                        console.log('ğŸš€ ~ url:', url)
                        spineAssets.image = url
                        updateFileStatus('image', file.name)
                        tryLoadAnimation()
                    }
                })
            }

            // å°è¯•åŠ è½½åŠ¨ç”»
            function tryLoadAnimation() {
                if (
                    spineAssets.json &&
                    spineAssets.atlas &&
                    spineAssets.image
                ) {
                    // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿DOMæ›´æ–°
                    setTimeout(() => {
                        loadSpineAnimation()
                    }, 100)
                }
            }
        </script>
    </body>
</html>
